#!/bin/bash
#
# Malware Verification Script
#
# Purpose: Automated scanning of repository files for malware using ClamAV
# Method: ClamAV virus scanner
#
# Exit codes:
#   0 = Scan passed (no malware found)
#   1 = Malware detected or scan error
#
# Usage: ./check-malware.sh [target_directory]
#        If no target specified, uses parent directory of script location

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Allow target directory to be specified as argument
if [ -n "$1" ]; then
    TARGET_DIR="$1"
else
    TARGET_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
fi

TIMESTAMP=$(date "+%Y-%m-%d %H:%M:%S")
REPO_NAME=$(basename "$TARGET_DIR")

# Check for clamscan
CLAMSCAN="/opt/homebrew/bin/clamscan"
if [ ! -x "$CLAMSCAN" ]; then
    CLAMSCAN=$(which clamscan 2>/dev/null || echo "")
fi

if [ -z "$CLAMSCAN" ] || [ ! -x "$CLAMSCAN" ]; then
    echo "ERROR: ClamAV (clamscan) not found"
    echo "Install with: brew install clamav"
    exit 1
fi

# Get ClamAV version
CLAMAV_VERSION=$($CLAMSCAN --version 2>/dev/null | head -1)

echo "Malware Verification Scan"
echo "========================="
echo "Timestamp: $TIMESTAMP"
echo "Scanner: $CLAMAV_VERSION"
echo "Target: $TARGET_DIR"
echo "Repository: $REPO_NAME"
echo ""

# Run scan and capture output
SCAN_OUTPUT=$(mktemp)
$CLAMSCAN --recursive --infected --no-summary "$TARGET_DIR" > "$SCAN_OUTPUT" 2>&1 || true

# Count infected files
INFECTED_COUNT=$(grep -c "FOUND$" "$SCAN_OUTPUT" 2>/dev/null || true)
if [ -z "$INFECTED_COUNT" ]; then
    INFECTED_COUNT=0
fi

# Get summary by running with summary
echo "Scan Summary:"
$CLAMSCAN --recursive "$TARGET_DIR" 2>&1 | tail -10

echo ""
echo "========================="

if [ "$INFECTED_COUNT" -eq 0 ]; then
    echo "RESULT: PASS"
    echo "No malware detected."
    EXIT_CODE=0
else
    echo "RESULT: FAIL"
    echo "$INFECTED_COUNT infected file(s) detected!"
    echo ""
    echo "Infected files:"
    cat "$SCAN_OUTPUT"
    EXIT_CODE=1
fi

rm -f "$SCAN_OUTPUT"

exit $EXIT_CODE
