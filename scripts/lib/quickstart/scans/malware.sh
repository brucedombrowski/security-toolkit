#!/bin/bash
#
# Shared Malware Scan Module
#
# Purpose: ClamAV malware scanning for both local and remote targets
# Used by: local.sh, remote.sh
#
# Note: This file is sourced, not executed directly

# Prevent direct execution
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    echo "Error: This script should be sourced, not executed directly." >&2
    exit 1
fi

# Run ClamAV malware scan
#
# Arguments:
#   $1 - Command runner function name (empty string for local, "ssh_cmd" for remote)
#   $2 - Sudo command runner (empty for local sudo, "ssh_cmd_sudo" for remote)
#   $3 - Output file path
#   $4 - Target description (hostname or path)
#   $5 - Timestamp
#
# Returns:
#   0 - Pass (no malware or scan completed)
#   1 - Fail (malware detected)
#   2 - Skip (ClamAV not available)
#
# Side effects:
#   Sets MALWARE_RESULT to "PASS", "FAIL", or "SKIP"
#   Sets INSTALLED_CLAMAV=true if ClamAV was installed
#
run_malware_scan() {
    local run_cmd="$1"
    local sudo_cmd="$2"
    local output_file="$3"
    local target_desc="$4"
    local timestamp="$5"

    # Helper to run commands locally or remotely
    _run() {
        if [ -n "$run_cmd" ]; then
            $run_cmd "$@"
        else
            eval "$@"
        fi
    }

    _run_sudo() {
        if [ -n "$sudo_cmd" ]; then
            $sudo_cmd "$@"
        else
            sudo "$@"
        fi
    }

    # Check if clamscan is available
    if _run "command -v clamscan" &>/dev/null; then
        {
            echo "Malware Scan (ClamAV)"
            echo "====================="
            echo "Target: $target_desc"
            echo "Scanned: $timestamp"
            echo ""

            echo "--- ClamAV Version ---"
            _run "clamscan --version" 2>/dev/null || echo "(failed to get version)"
            echo ""

            echo "--- Scan Results ---"
            echo "Scanning with common exclusions..."
            echo ""
            # Scan target paths (configurable via MALWARE_SCAN_PATHS)
            local scan_paths="${MALWARE_SCAN_PATHS:-~/}"
            echo "Scan paths: $scan_paths"
            _run "clamscan --recursive --infected \
                --exclude-dir='.git' \
                --exclude-dir='node_modules' \
                --exclude-dir='.cache' \
                --exclude-dir='.local/share/Trash' \
                $scan_paths 2>&1" 2>/dev/null || echo "(scan completed with warnings)"

        } > "$output_file" 2>&1

        # Check for infections in the output
        if grep -q "Infected files: 0" "$output_file" 2>/dev/null; then
            MALWARE_RESULT="PASS"
            return 0
        elif grep -q "FOUND" "$output_file" 2>/dev/null; then
            MALWARE_RESULT="FAIL"
            return 1
        else
            MALWARE_RESULT="PASS"
            return 0
        fi
    else
        # ClamAV not installed
        MALWARE_RESULT="SKIP"
        return 2
    fi
}

# Offer to install ClamAV and run scan
#
# Arguments:
#   $1 - Command runner function name
#   $2 - Sudo command runner
#   $3 - Output file path
#   $4 - Target description
#   $5 - Timestamp
#   $6 - Package manager hint ("apt", "brew", "dnf", etc.)
#
# Returns: Same as run_malware_scan
#
offer_install_and_scan_malware() {
    local run_cmd="$1"
    local sudo_cmd="$2"
    local output_file="$3"
    local target_desc="$4"
    local timestamp="$5"
    local pkg_mgr="${6:-apt}"

    print_warning "ClamAV not installed"
    echo -n "  Install ClamAV now? [y/N]: "
    read -r install_ans </dev/tty

    if [[ "$install_ans" =~ ^[Yy] ]]; then
        echo "  Installing ClamAV..."

        local install_cmd=""
        case "$pkg_mgr" in
            apt)    install_cmd="sudo apt install -y clamav" ;;
            brew)   install_cmd="brew install clamav" ;;
            dnf)    install_cmd="sudo dnf install -y clamav" ;;
            yum)    install_cmd="sudo yum install -y clamav" ;;
            pacman) install_cmd="sudo pacman -S --noconfirm clamav" ;;
        esac

        if [ -n "$sudo_cmd" ]; then
            if $sudo_cmd "$install_cmd" 2>&1; then
                print_success "ClamAV installed"
                INSTALLED_CLAMAV=true
            else
                print_error "ClamAV installation failed"
                MALWARE_RESULT="SKIP"
                return 2
            fi
        else
            if eval "$install_cmd" 2>&1; then
                print_success "ClamAV installed"
                INSTALLED_CLAMAV=true
            else
                print_error "ClamAV installation failed"
                MALWARE_RESULT="SKIP"
                return 2
            fi
        fi

        # Update virus database if needed
        if [ -n "$run_cmd" ]; then
            if $run_cmd "systemctl is-active clamav-freshclam" &>/dev/null; then
                echo "  Virus database update service running"
            else
                echo "  Updating virus database..."
                $sudo_cmd "sudo freshclam" 2>&1 || echo "  (freshclam update skipped)"
            fi
        fi

        # Now run the scan
        run_malware_scan "$run_cmd" "$sudo_cmd" "$output_file" "$target_desc" "$timestamp"
        return $?
    else
        # User declined installation
        {
            echo "Malware Scan (ClamAV)"
            echo "====================="
            echo "Target: $target_desc"
            echo "Checked: $timestamp"
            echo ""
            echo "ClamAV not installed - user declined installation."
        } > "$output_file" 2>&1
        MALWARE_RESULT="SKIP"
        return 2
    fi
}
