#!/bin/bash
#
# Malware Scanner Integration Tests
#
# Purpose: Verify check-malware.sh detects malware correctly
# NIST Control: SI-3 (Malicious Code Protection)
#
# Tests:
#   - Script exists and is executable
#   - Clean directory returns exit 0 (pass)
#   - EICAR test file returns exit 1 (fail)
#   - Missing ClamAV returns exit 2 (skip)
#
# Usage: ./tests/test-malware.sh
#
# Exit codes:
#   0 = All tests passed
#   1 = One or more tests failed

set -eu

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
FIXTURES_DIR="$SCRIPT_DIR/fixtures"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

TESTS_RUN=0
TESTS_PASSED=0
TESTS_FAILED=0
TESTS_SKIPPED=0

# Test helper functions
test_start() {
    TESTS_RUN=$((TESTS_RUN + 1))
    echo -n "  Test $TESTS_RUN: $1... "
}

test_pass() {
    TESTS_PASSED=$((TESTS_PASSED + 1))
    echo -e "${GREEN}PASS${NC}"
}

test_fail() {
    TESTS_FAILED=$((TESTS_FAILED + 1))
    echo -e "${RED}FAIL${NC}"
    echo "    Expected: $1"
    echo "    Got: $2"
}

test_skip() {
    TESTS_SKIPPED=$((TESTS_SKIPPED + 1))
    TESTS_RUN=$((TESTS_RUN - 1))
    echo -e "${YELLOW}SKIP${NC} ($1)"
}

section_header() {
    echo ""
    echo -e "${CYAN}--- $1 ---${NC}"
}

# Test directories (cleaned up on exit)
CLEAN_TEST_DIR=""
MALWARE_TEST_DIR=""

# Cleanup function
cleanup() {
    if [ -n "$CLEAN_TEST_DIR" ] && [ -d "$CLEAN_TEST_DIR" ]; then
        rm -rf "$CLEAN_TEST_DIR"
    fi
    if [ -n "$MALWARE_TEST_DIR" ] && [ -d "$MALWARE_TEST_DIR" ]; then
        rm -rf "$MALWARE_TEST_DIR"
    fi
}
trap cleanup EXIT

# Check if ClamAV is installed AND has a valid database
check_clamav() {
    local clamscan_path=""

    # Find clamscan binary
    if command -v clamscan &>/dev/null; then
        clamscan_path="clamscan"
    elif [ -x "/opt/homebrew/bin/clamscan" ]; then
        clamscan_path="/opt/homebrew/bin/clamscan"
    elif [ -x "/usr/local/bin/clamscan" ]; then
        clamscan_path="/usr/local/bin/clamscan"
    elif [ -x "/usr/bin/clamscan" ]; then
        clamscan_path="/usr/bin/clamscan"
    else
        return 1
    fi

    # Verify ClamAV has a valid database by running a quick version check
    # clamscan --version returns database info if available
    if $clamscan_path --version 2>/dev/null | grep -q "ClamAV"; then
        # Try a quick scan to verify database is functional
        # Create a temp file and scan it - this will fail if no database
        local test_file
        test_file=$(mktemp)
        echo "test" > "$test_file"
        if $clamscan_path --no-summary "$test_file" >/dev/null 2>&1; then
            rm -f "$test_file"
            return 0
        fi
        rm -f "$test_file"
    fi

    return 1
}

# Generate EICAR test file content
# EICAR is the industry-standard test file for antivirus detection
# Ref: https://www.eicar.org/download-anti-malware-testfile/
# We construct it at runtime to avoid triggering any security scanners on the repo
generate_eicar() {
    # EICAR test string (68 bytes)
    # X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*
    local part1='X5O!P%@AP[4\'
    local part2='PZX54(P^)7CC)7}'
    local part3='$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*'
    printf '%s%s%s' "$part1" "$part2" "$part3"
}

echo "=========================================="
echo "Malware Scanner Integration Tests"
echo "=========================================="
echo ""

# -----------------------------------------------------------------------------
# Script Validation Tests
# -----------------------------------------------------------------------------
section_header "Script Validation"

test_start "check-malware.sh exists"
if [ -f "$REPO_DIR/scripts/check-malware.sh" ]; then
    test_pass
else
    test_fail "file exists" "file not found"
fi

test_start "check-malware.sh is executable"
if [ -x "$REPO_DIR/scripts/check-malware.sh" ]; then
    test_pass
else
    test_fail "executable" "not executable"
fi

# -----------------------------------------------------------------------------
# ClamAV Availability Tests
# -----------------------------------------------------------------------------
section_header "ClamAV Detection"

CLAMAV_AVAILABLE=false
test_start "ClamAV (clamscan) is available"
if check_clamav; then
    test_pass
    CLAMAV_AVAILABLE=true
else
    test_skip "ClamAV not installed"
fi

# -----------------------------------------------------------------------------
# Functional Tests (require ClamAV)
# -----------------------------------------------------------------------------
section_header "Functional Tests"

if [ "$CLAMAV_AVAILABLE" = "true" ]; then
    # Test: Clean directory should pass (exit 0)
    test_start "Clean directory returns exit 0"
    CLEAN_TEST_DIR=$(mktemp -d)
    echo "This is a clean test file." > "$CLEAN_TEST_DIR/clean.txt"

    EXIT_CODE=0
    SCAN_OUTPUT=$("$REPO_DIR/scripts/check-malware.sh" "$CLEAN_TEST_DIR" 2>&1) || EXIT_CODE=$?

    if [ "$EXIT_CODE" -eq 0 ]; then
        test_pass
    else
        test_fail "exit 0" "exit $EXIT_CODE"
        # Show last 20 lines of output for debugging
        echo "    --- Debug output (last 20 lines) ---"
        echo "$SCAN_OUTPUT" | tail -20 | sed 's/^/    /'
        echo "    --- End debug output ---"
    fi

    # Test: EICAR test file should fail (exit 1)
    test_start "EICAR test file returns exit 1 (malware detected)"
    MALWARE_TEST_DIR=$(mktemp -d)

    # Create EICAR test file
    generate_eicar > "$MALWARE_TEST_DIR/eicar-test.com"

    EXIT_CODE=0
    "$REPO_DIR/scripts/check-malware.sh" "$MALWARE_TEST_DIR" >/dev/null 2>&1 || EXIT_CODE=$?

    if [ "$EXIT_CODE" -eq 1 ]; then
        test_pass
    else
        test_fail "exit 1 (malware detected)" "exit $EXIT_CODE"
    fi

    # Test: Verify scan creates output files
    test_start "Scan creates .scans directory"
    if [ -d "$CLEAN_TEST_DIR/.scans" ]; then
        test_pass
    else
        test_fail ".scans directory exists" "not found"
    fi

    test_start "Scan creates ClamAV log file"
    if ls "$CLEAN_TEST_DIR/.scans"/clamav-log-*.txt 1>/dev/null 2>&1; then
        test_pass
    else
        test_fail "clamav-log-*.txt exists" "not found"
    fi

else
    # Skip functional tests if ClamAV not available
    test_start "Clean directory test"
    test_skip "ClamAV not installed"

    test_start "EICAR detection test"
    test_skip "ClamAV not installed"

    test_start "Scan output directory test"
    test_skip "ClamAV not installed"

    test_start "Scan log file test"
    test_skip "ClamAV not installed"
fi

# -----------------------------------------------------------------------------
# Exit Code Validation
# -----------------------------------------------------------------------------
section_header "Exit Code Validation"

if [ "$CLAMAV_AVAILABLE" = "false" ]; then
    test_start "Missing ClamAV returns exit 2"
    # We've already determined ClamAV is missing, so running the script should return exit 2
    EXIT_CODE=0
    "$REPO_DIR/scripts/check-malware.sh" "$(mktemp -d)" >/dev/null 2>&1 || EXIT_CODE=$?

    if [ "$EXIT_CODE" -eq 2 ]; then
        test_pass
    else
        test_fail "exit 2 (dependency missing)" "exit $EXIT_CODE"
    fi
else
    test_start "Exit code 2 test"
    test_skip "ClamAV is installed (cannot test missing dependency)"
fi

# -----------------------------------------------------------------------------
# Summary
# -----------------------------------------------------------------------------
echo ""
echo "=========================================="
echo "Summary"
echo "=========================================="
echo "Tests run:    $TESTS_RUN"
echo "Passed:       $TESTS_PASSED"
echo "Failed:       $TESTS_FAILED"
echo "Skipped:      $TESTS_SKIPPED"
echo ""

if [ "$TESTS_FAILED" -gt 0 ]; then
    echo -e "${RED}RESULT: FAIL${NC}"
    exit 1
else
    echo -e "${GREEN}RESULT: PASS${NC}"
    exit 0
fi
